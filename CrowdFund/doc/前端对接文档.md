# CrowdFund 项目前端对接文档

## 1. 项目概述

CrowdFund 是一个基于以太坊的众筹平台，允许用户创建众筹项目、进行投资并获得相应的 MYB 代币。本项目包含三个主要合约：

- **MYBToken**: 用于众筹奖励的 ERC20 代币合约
- **InvestorRegistry**: 管理投资者信息的注册表合约
- **CrowdFundCore**: 核心众筹逻辑合约，管理众筹活动的创建、投资和资金发放

## 2. 合约地址获取

在前端代码中，首先需要获取已部署的合约地址。这些地址通常在部署脚本执行后会输出，也可以通过读取部署日志文件获取。

```javascript
// 假设已经部署的合约地址
const mybTokenAddress = "0x...";
const investorRegistryAddress = "0x...";
const crowdFundCoreAddress = "0x...";
```

## 3. 合约 ABI 引入

前端代码需要引入合约的 ABI（应用二进制接口）才能与合约交互。ABI 可以从编译后的 JSON 文件中获取。

```javascript
// 可以通过导入编译后的 JSON 文件获取 ABI
import mybTokenABI from "./artifacts/contracts/MYBToken.sol/MYBToken.json";
import investorRegistryABI from "./artifacts/contracts/InvestorRegistry.sol/InvestorRegistry.json";
import crowdFundCoreABI from "./artifacts/contracts/CrowdFundCore.sol/CrowdFundCore.json";
```

## 4. Web3 实例化

使用 web3.js 或 ethers.js 与以太坊网络交互。

```javascript
// 使用 ethers.js
import { ethers } from "ethers";

// 连接到以太坊提供者（如 MetaMask）
const provider = new ethers.providers.Web3Provider(window.ethereum);
const signer = provider.getSigner();

// 实例化合约
const mybToken = new ethers.Contract(mybTokenAddress, mybTokenABI.abi, signer);
const investorRegistry = new ethers.Contract(investorRegistryAddress, investorRegistryABI.abi, signer);
const crowdFundCore = new ethers.Contract(crowdFundCoreAddress, crowdFundCoreABI.abi, signer);
```

## 5. 核心合约接口

### 5.1 CrowdFundCore 接口

#### 5.1.1 创建众筹活动

```javascript
/**
 * @param projectName 项目名称
 * @param targetAmount 目标金额（以 wei 为单位，使用 ethers.utils.parseEther() 转换）
 * @param deadline 截止时间戳
 */
async function createCrowdfund(projectName, targetAmount, deadline) {
  try {
    const tx = await crowdFundCore.createCrowdfund(
      projectName, 
      ethers.utils.parseEther(targetAmount), 
      deadline
    );
    await tx.wait();
    console.log("众筹活动创建成功", tx.hash);
    return tx;
  } catch (error) {
    console.error("创建众筹活动失败", error);
  }
}
```

#### 5.1.2 参与众筹投资

```javascript
/**
 * @param crowdfundId 众筹 ID
 * @param amount 投资金额（以 ETH 为单位）
 * @notice 最小投资金额为 0.01 ETH
 */
async function invest(crowdfundId, amount) {
  try {
    const tx = await crowdFundCore.invest(crowdfundId, {
      value: ethers.utils.parseEther(amount)
    });
    await tx.wait();
    console.log("投资成功", tx.hash);
    return tx;
  } catch (error) {
    console.error("投资失败", error);
  }
}
```

#### 5.1.3 结束众筹活动

```javascript
/**
 * @param crowdfundId 众筹 ID
 * @notice 只有在众筹截止时间之后才能调用
 */
async function finalizeCrowdfund(crowdfundId) {
  try {
    const tx = await crowdFundCore.finalizeCrowdfund(crowdfundId);
    await tx.wait();
    console.log("众筹活动已结束", tx.hash);
    return tx;
  } catch (error) {
    console.error("结束众筹活动失败", error);
  }
}
```

#### 5.1.4 释放众筹资金（仅合约所有者）

```javascript
/**
 * @param crowdfundId 众筹 ID
 * @notice 只有众筹成功且资金未释放时才能调用
 */
async function releaseFunds(crowdfundId) {
  try {
    const tx = await crowdFundCore.releaseFunds(crowdfundId);
    await tx.wait();
    console.log("资金释放成功", tx.hash);
    return tx;
  } catch (error) {
    console.error("资金释放失败", error);
  }
}
```

#### 5.1.5 申请退款（众筹失败）

```javascript
/**
 * @param crowdfundId 众筹 ID
 * @notice 只有众筹失败时才能调用
 */
async function claimRefund(crowdfundId) {
  try {
    const tx = await crowdFundCore.claimRefund(crowdfundId);
    await tx.wait();
    console.log("退款成功", tx.hash);
    return tx;
  } catch (error) {
    console.error("退款失败", error);
  }
}
```

#### 5.1.6 领取 MYB 代币（众筹成功）

```javascript
/**
 * @param crowdfundId 众筹 ID
 * @notice 只有众筹成功且资金已释放时才能调用
 */
async function claimTokens(crowdfundId) {
  try {
    const tx = await crowdFundCore.claimTokens(crowdfundId);
    await tx.wait();
    console.log("代币领取成功", tx.hash);
    return tx;
  } catch (error) {
    console.error("代币领取失败", error);
  }
}
```

#### 5.1.7 查询众筹状态

```javascript
/**
 * @param crowdfundId 众筹 ID
 * @returns 众筹活动详情
 */
async function getCrowdfundStatus(crowdfundId) {
  try {
    const crowdfund = await crowdFundCore.getCrowdfundStatus(crowdfundId);
    // 转换返回的 BigNumber 为可读格式
    return {
      id: crowdfund.id.toString(),
      projectName: crowdfund.projectName,
      creator: crowdfund.creator,
      targetAmount: ethers.utils.formatEther(crowdfund.targetAmount),
      currentAmount: ethers.utils.formatEther(crowdfund.currentAmount),
      deadline: new Date(crowdfund.deadline.toNumber() * 1000).toLocaleString(),
      mybPerEth: crowdfund.mybPerEth.toString(),
      status: getStatusName(crowdfund.status.toNumber()),
      createdAt: new Date(crowdfund.createdAt.toNumber() * 1000).toLocaleString(),
      fundsReleased: crowdfund.fundsReleased
    };
  } catch (error) {
    console.error("查询众筹状态失败", error);
  }
}

// 状态码映射
function getStatusName(status) {
  const statusMap = {
    0: "待处理",
    1: "进行中",
    2: "成功",
    3: "失败",
    4: "已退款"
  };
  return statusMap[status] || "未知";
}
```

#### 5.1.8 查询合约余额

```javascript
/**
 * @returns 合约当前 ETH 余额
 */
async function getContractBalance() {
  try {
    const balance = await crowdFundCore.getContractBalance();
    return ethers.utils.formatEther(balance);
  } catch (error) {
    console.error("查询合约余额失败", error);
  }
}
```

### 5.2 MYBToken 接口

#### 5.2.1 查询代币余额

```javascript
/**
 * @param address 查询地址
 * @returns 代币余额
 */
async function getTokenBalance(address) {
  try {
    const balance = await mybToken.balanceOf(address);
    return ethers.utils.formatEther(balance);
  } catch (error) {
    console.error("查询代币余额失败", error);
  }
}
```

#### 5.2.2 查询 ETH 与 MYB 兑换比例

```javascript
/**
 * @returns 当前 ETH 兑换 MYB 的比例
 * @notice 当前兑换比例为 1 ETH = 10000 MYB
 */
async function getExchangeRate() {
  try {
    const rate = await mybToken.exchangeRate();
    return rate.toString();
  } catch (error) {
    console.error("查询兑换比例失败", error);
  }
}
```

### 5.3 InvestorRegistry 接口

#### 5.3.1 查询投资者信息

```javascript
/**
 * @param crowdfundId 众筹 ID
 * @param investorAddress 投资者地址
 * @returns 投资者信息
 */
async function getInvestorInfo(crowdfundId, investorAddress) {
  try {
    const investor = await investorRegistry.getInvestorInfo(crowdfundId, investorAddress);
    return {
      isRegistered: investor.isRegistered,
      totalInvestment: ethers.utils.formatEther(investor.totalInvestment),
      mybTokens: ethers.utils.formatEther(investor.mybTokens),
      tokensClaimed: ethers.utils.formatEther(investor.tokensClaimed)
    };
  } catch (error) {
    console.error("查询投资者信息失败", error);
  }
}
```

## 6. 事件监听

前端可以监听合约事件以实现实时更新功能。

### 6.1 监听众筹创建事件

```javascript
/**
 * 监听新众筹活动创建事件
 * @param callback 回调函数，接收事件参数
 */
function listenForNewCrowdfunds(callback) {
  crowdFundCore.on("CrowdfundCreated", (crowdfundId, projectName, creator, targetAmount, deadline, event) => {
    callback({
      crowdfundId: crowdfundId.toString(),
      projectName,
      creator,
      targetAmount: ethers.utils.formatEther(targetAmount),
      deadline: new Date(deadline.toNumber() * 1000).toLocaleString(),
      transactionHash: event.transactionHash
    });
  });
}
```

### 6.2 监听投资事件

```javascript
/**
 * 监听投资事件
 * @param callback 回调函数，接收事件参数
 */
function listenForInvestments(callback) {
  crowdFundCore.on("InvestmentReceived", (crowdfundId, investor, amount, mybTokens, event) => {
    callback({
      crowdfundId: crowdfundId.toString(),
      investor,
      amount: ethers.utils.formatEther(amount),
      mybTokens: ethers.utils.formatEther(mybTokens),
      transactionHash: event.transactionHash
    });
  });
}
```

### 6.3 监听众筹成功事件

```javascript
/**
 * 监听众筹成功事件
 * @param callback 回调函数，接收事件参数
 */
function listenForCrowdfundSuccess(callback) {
  crowdFundCore.on("CrowdfundSuccessful", (crowdfundId, totalAmount, event) => {
    callback({
      crowdfundId: crowdfundId.toString(),
      totalAmount: ethers.utils.formatEther(totalAmount),
      transactionHash: event.transactionHash
    });
  });
}
```

## 7. 完整流程示例

### 7.1 创建众筹活动流程

```javascript
// 1. 用户填写众筹表单
// 2. 前端计算截止时间戳（例如：现在 + 30 天）
const deadline = Math.floor(Date.now() / 1000) + 30 * 24 * 60 * 60;

// 3. 调用创建众筹函数
const projectName = "测试项目";
const targetAmount = "10"; // 10 ETH
await createCrowdfund(projectName, targetAmount, deadline);
```

### 7.2 投资流程

```javascript
// 1. 用户选择要投资的众筹项目和金额
const crowdfundId = 1;
const investmentAmount = "0.1";

// 2. 检查是否达到最小投资金额（0.01 ETH）
if (parseFloat(investmentAmount) < 0.01) {
  alert("投资金额不能少于 0.01 ETH");
  return;
}

// 3. 调用投资函数
await invest(crowdfundId, investmentAmount);
```

### 7.3 众筹成功后领取代币流程

```javascript
// 1. 用户查询众筹状态
const crowdfundId = 1;
const status = await getCrowdfundStatus(crowdfundId);

// 2. 检查众筹是否成功且资金已释放
if (status.status === "成功" && status.fundsReleased) {
  // 3. 调用领取代币函数
  await claimTokens(crowdfundId);
  alert("代币领取成功");
} else {
  alert("众筹未成功或资金尚未释放");
}
```

### 7.4 众筹失败后申请退款流程

```javascript
// 1. 用户查询众筹状态
const crowdfundId = 1;
const status = await getCrowdfundStatus(crowdfundId);

// 2. 检查众筹是否失败
if (status.status === "失败") {
  // 3. 调用申请退款函数
  await claimRefund(crowdfundId);
  alert("退款申请成功");
} else {
  alert("众筹未失败，无法申请退款");
}
```

## 8. 注意事项

1. **最小投资金额**: 合约设置了最小投资金额为 0.01 ETH，前端在用户输入时应进行验证提示。

2. **交易确认**: 所有涉及 ETH 转账的操作需要用户确认交易，前端应提供友好的提示和加载状态。

3. **Gas 费用**: 前端应考虑 Gas 费用估算，特别是对于涉及复杂逻辑的操作。

4. **余额检查**: 在发起交易前，前端应检查用户的 ETH 余额是否足够支付交易金额和 Gas 费用。

5. **错误处理**: 所有与合约交互的函数都应包含错误处理逻辑，向用户提供清晰的错误信息。

6. **事件监听清理**: 在组件卸载时，应清理事件监听器以避免内存泄漏。

7. **用户体验**: 对于长时间运行的操作，应提供加载指示器，并在操作完成后给予明确的反馈。

## 9. 安全建议

1. **合约地址验证**: 在连接合约前，请确保使用正确的合约地址。

2. **合约状态检查**: 在执行关键操作前，始终检查相关合约的当前状态。

3. **用户授权**: 确保用户理解他们要执行的操作及其后果，特别是涉及资金的操作。

4. **网络选择**: 前端应确保用户连接到正确的以太坊网络（测试网或主网）。

---

以上就是 CrowdFund 项目的前端对接文档，包含了与合约交互所需的主要接口和方法。如有任何问题或需要进一步的文档，请随时联系开发团队。